#!/bin/bash

# Source app helpers
source /usr/share/yunohost/helpers

# Exit on command errors and treat unset variables as an error
set -u

app=$YNH_APP_INSTANCE_NAME

# Retrieve app settings
domain=$(ynh_app_setting_get $app domain)

sudo systemctl stop $app.service

# Remove sources
ynh_secure_remove /var/www/$app

# Remove nginx configuration file
[[ -n $domain ]] && sudo rm -f /etc/nginx/conf.d/${domain}.d/${app}.conf

# Delete system user dedicace for this app
ynh_system_user_delete $app

# Remove init script
sudo systemctl disable $app.service
sudo rm -f /etc/systemd/system/$app.service
sudo systemctl daemon-reload

# Remove monitor
sudo yunohost service remove $app

# Reload nginx service
sudo systemctl reload nginx.service
